"use strict";(self.webpackChunkrke_docs=self.webpackChunkrke_docs||[]).push([[7100],{8613:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>r,contentTitle:()=>i,default:()=>l,frontMatter:()=>o,metadata:()=>d,toc:()=>a});var t=n(5893),c=n(1151);const o={title:"One-time Snapshots"},i=void 0,d={id:"etcd-snapshots/one-time-snapshots/one-time-snapshots",title:"One-time Snapshots",description:"One-time snapshots are handled differently depending on your version of RKE.",source:"@site/docs/etcd-snapshots/one-time-snapshots/one-time-snapshots.md",sourceDirName:"etcd-snapshots/one-time-snapshots",slug:"/etcd-snapshots/one-time-snapshots/",permalink:"/etcd-snapshots/one-time-snapshots/",draft:!1,unlisted:!1,editUrl:"https://github.com/rancher/rke1-docs/edit/main/docs/etcd-snapshots/one-time-snapshots/one-time-snapshots.md",tags:[],version:"current",lastUpdatedAt:1708018833,formattedLastUpdatedAt:"Feb 15, 2024",frontMatter:{title:"One-time Snapshots"},sidebar:"mySidebar",previous:{title:"Backups and Disaster Recovery",permalink:"/etcd-snapshots/"},next:{title:"Recurring Snapshots",permalink:"/etcd-snapshots/recurring-snapshots/"}},r={},a=[{value:"Options for <code>rke etcd snapshot-save</code>",id:"options-for-rke-etcd-snapshot-save",level:3},{value:"Using a custom CA certificate for S3",id:"using-a-custom-ca-certificate-for-s3",level:5},{value:"IAM Support for Storing Snapshots in S3",id:"iam-support-for-storing-snapshots-in-s3",level:3},{value:"Options for <code>rke etcd snapshot-save</code>",id:"options-for-rke-etcd-snapshot-save-1",level:3}];function h(e){const s={a:"a",code:"code",em:"em",h3:"h3",h5:"h5",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,c.a)(),...e.components},{TabItem:n,Tabs:o}=s;return n||p("TabItem",!0),o||p("Tabs",!0),(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(s.p,{children:"One-time snapshots are handled differently depending on your version of RKE."}),"\n",(0,t.jsxs)(o,{children:[(0,t.jsxs)(n,{value:"RKE v0.2.0+",children:[(0,t.jsxs)(s.p,{children:["To save a snapshot of etcd from each etcd node in the cluster config file, run the ",(0,t.jsx)(s.code,{children:"rke etcd snapshot-save"})," command."]}),(0,t.jsxs)(s.p,{children:["The snapshot is saved in ",(0,t.jsx)(s.code,{children:"/opt/rke/etcd-snapshots"}),"."]}),(0,t.jsx)(s.p,{children:"When running the command, an additional container is created to take the snapshot. When the snapshot is completed, the container is automatically removed."}),(0,t.jsx)(s.p,{children:"The one-time snapshot can be uploaded to a S3 compatible backend by using the additional options to specify the S3 backend."}),(0,t.jsx)(s.p,{children:"To create a local one-time snapshot, run:"}),(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{children:"$ rke etcd snapshot-save --config cluster.yml --name snapshot-name\n"})}),(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Result:"})," The snapshot is saved in ",(0,t.jsx)(s.code,{children:"/opt/rke/etcd-snapshots"}),"."]}),(0,t.jsx)(s.p,{children:"To save a one-time snapshot to S3, run:"}),(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{children:"$ rke etcd snapshot-save \\\n--config cluster.yml \\\n--name snapshot-name \\\n--s3 \\\n--access-key S3_ACCESS_KEY \\\n--secret-key S3_SECRET_KEY \\\n--bucket-name s3-bucket-name \\\n--folder s3-folder-name \\ # Optional - Available as of v0.3.0\n--s3-endpoint s3.amazonaws.com\n"})}),(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Result:"})," The snapshot is saved in ",(0,t.jsx)(s.code,{children:"/opt/rke/etcd-snapshots"})," as well as uploaded to the S3 backend."]}),(0,t.jsxs)(s.h3,{id:"options-for-rke-etcd-snapshot-save",children:["Options for ",(0,t.jsx)(s.code,{children:"rke etcd snapshot-save"})]}),(0,t.jsxs)(s.table,{children:[(0,t.jsx)(s.thead,{children:(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.th,{children:"Option"}),(0,t.jsx)(s.th,{children:"Description"}),(0,t.jsx)(s.th,{children:"S3 Specific"})]})}),(0,t.jsxs)(s.tbody,{children:[(0,t.jsxs)(s.tr,{children:[(0,t.jsxs)(s.td,{children:[(0,t.jsx)(s.code,{children:"--name"})," value"]}),(0,t.jsx)(s.td,{children:"Specify snapshot name"}),(0,t.jsx)(s.td,{})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsxs)(s.td,{children:[(0,t.jsx)(s.code,{children:"--config"})," value"]}),(0,t.jsxs)(s.td,{children:["Specify an alternate cluster YAML file (default: ",(0,t.jsx)(s.code,{children:"cluster.yml"}),") [$RKE_CONFIG]"]}),(0,t.jsx)(s.td,{})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"--s3"})}),(0,t.jsx)(s.td,{children:"Enabled backup to s3"}),(0,t.jsx)(s.td,{children:"*"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsxs)(s.td,{children:[(0,t.jsx)(s.code,{children:"--s3-endpoint"})," value"]}),(0,t.jsx)(s.td,{children:'Specify s3 endpoint url (default: "s3.amazonaws.com")'}),(0,t.jsx)(s.td,{children:"*"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsxs)(s.td,{children:[(0,t.jsx)(s.code,{children:"--s3-endpoint-ca"})," value"]}),(0,t.jsxs)(s.td,{children:["Specify a path to a CA cert file to connect to a custom s3 endpoint (optional) ",(0,t.jsx)(s.em,{children:"Available as of v0.2.5"})]}),(0,t.jsx)(s.td,{children:"*"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsxs)(s.td,{children:[(0,t.jsx)(s.code,{children:"--access-key"})," value"]}),(0,t.jsx)(s.td,{children:"Specify s3 accessKey"}),(0,t.jsx)(s.td,{children:"*"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsxs)(s.td,{children:[(0,t.jsx)(s.code,{children:"--secret-key"})," value"]}),(0,t.jsx)(s.td,{children:"Specify s3 secretKey"}),(0,t.jsx)(s.td,{children:"*"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsxs)(s.td,{children:[(0,t.jsx)(s.code,{children:"--bucket-name"})," value"]}),(0,t.jsx)(s.td,{children:"Specify s3 bucket name"}),(0,t.jsx)(s.td,{children:"*"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsxs)(s.td,{children:[(0,t.jsx)(s.code,{children:"--folder"})," value"]}),(0,t.jsxs)(s.td,{children:["Specify folder inside  bucket where backup will be stored. This is optional. ",(0,t.jsx)(s.em,{children:"Available as of v0.3.0"})]}),(0,t.jsx)(s.td,{children:"*"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsxs)(s.td,{children:[(0,t.jsx)(s.code,{children:"--region"})," value"]}),(0,t.jsx)(s.td,{children:"Specify the s3 bucket location (optional)"}),(0,t.jsx)(s.td,{children:"*"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"--ssh-agent-auth"})}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.a,{href:"/config-options/#ssh-agent",children:"Use SSH Agent Auth defined by SSH_AUTH_SOCK"})}),(0,t.jsx)(s.td,{})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"--ignore-docker-version"})}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.a,{href:"/config-options/#supported-docker-versions",children:"Disable Docker version check"})}),(0,t.jsx)(s.td,{})]})]})]}),(0,t.jsxs)(s.p,{children:["The ",(0,t.jsx)(s.code,{children:"--access-key"})," and ",(0,t.jsx)(s.code,{children:"--secret-key"})," options are not required if the ",(0,t.jsx)(s.code,{children:"etcd"})," nodes are AWS EC2 instances that have been configured with a suitable IAM instance profile."]}),(0,t.jsx)(s.h5,{id:"using-a-custom-ca-certificate-for-s3",children:"Using a custom CA certificate for S3"}),(0,t.jsx)(s.p,{children:(0,t.jsx)(s.em,{children:"Available as of v0.2.0"})}),(0,t.jsxs)(s.p,{children:["The backup snapshot can be stored on a custom ",(0,t.jsx)(s.code,{children:"S3"})," backup like ",(0,t.jsx)(s.a,{href:"https://min.io/",children:"minio"}),". If the S3 backend uses a self-signed or custom certificate, provide a custom certificate using the ",(0,t.jsx)(s.code,{children:"--s3-endpoint-ca"})," to connect to the S3 backend."]}),(0,t.jsx)(s.h3,{id:"iam-support-for-storing-snapshots-in-s3",children:"IAM Support for Storing Snapshots in S3"}),(0,t.jsx)(s.p,{children:"In addition to API access keys, RKE supports using IAM roles for S3 authentication. The cluster etcd nodes must be assigned an IAM role that has read/write access to the designated backup bucket on S3. Also, the nodes must have network access to the S3 endpoint specified."}),(0,t.jsxs)(s.p,{children:["Below is an ",(0,t.jsx)(s.a,{href:"https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_examples_s3_rw-bucket.html",children:"example IAM policy"})," that would allow nodes to store and retrieve backups from S3:"]}),(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{children:'{\n    "Version": "2012-10-17",\n    "Statement": [\n        {\n            "Sid": "ListObjectsInBucket",\n            "Effect": "Allow",\n            "Action": ["s3:ListBucket"],\n            "Resource": ["arn:aws:s3:::bucket-name"]\n        },\n        {\n            "Sid": "AllObjectActions",\n            "Effect": "Allow",\n            "Action": "s3:*Object",\n            "Resource": ["arn:aws:s3:::bucket-name/*"]\n        }\n    ]\n}\n'})}),(0,t.jsxs)(s.p,{children:["For details on giving an application access to S3, refer to the AWS documentation on ",(0,t.jsx)(s.a,{href:"https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_switch-role-ec2.html",children:"Using an IAM Role to Grant Permissions to Applications Running on Amazon EC2 Instances."})]})]}),(0,t.jsxs)(n,{value:"RKE before v0.2.0",children:[(0,t.jsxs)(s.p,{children:["To save a snapshot of etcd from each etcd node in the cluster config file, run the ",(0,t.jsx)(s.code,{children:"rke etcd snapshot-save"})," command."]}),(0,t.jsx)(s.p,{children:"When running the command, an additional container is created to take the snapshot. When the snapshot is completed, the container is automatically removed."}),(0,t.jsxs)(s.p,{children:["RKE saves a backup of the certificates, i.e. a file named ",(0,t.jsx)(s.code,{children:"pki.bundle.tar.gz"}),", in the same location. The snapshot and pki bundle file are required for the restore process."]}),(0,t.jsx)(s.p,{children:"To create a local one-time snapshot, run:"}),(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{children:"$ rke etcd snapshot-save --config cluster.yml --name snapshot-name\n"})}),(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Result:"})," The snapshot is saved in ",(0,t.jsx)(s.code,{children:"/opt/rke/etcd-snapshots"}),"."]}),(0,t.jsxs)(s.h3,{id:"options-for-rke-etcd-snapshot-save-1",children:["Options for ",(0,t.jsx)(s.code,{children:"rke etcd snapshot-save"})]}),(0,t.jsxs)(s.table,{children:[(0,t.jsx)(s.thead,{children:(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.th,{children:"Option"}),(0,t.jsx)(s.th,{children:"Description"})]})}),(0,t.jsxs)(s.tbody,{children:[(0,t.jsxs)(s.tr,{children:[(0,t.jsxs)(s.td,{children:[(0,t.jsx)(s.code,{children:"--name"})," value"]}),(0,t.jsx)(s.td,{children:"Specify snapshot name"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsxs)(s.td,{children:[(0,t.jsx)(s.code,{children:"--config"})," value"]}),(0,t.jsxs)(s.td,{children:["Specify an alternate cluster YAML file (default: ",(0,t.jsx)(s.code,{children:"cluster.yml"}),") [$RKE_CONFIG]"]})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"--ssh-agent-auth"})}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.a,{href:"/config-options/#ssh-agent",children:"Use SSH Agent Auth defined by SSH_AUTH_SOCK"})})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"--ignore-docker-version"})}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.a,{href:"/config-options/#supported-docker-versions",children:"Disable Docker version check"})})]})]})]})]})]})]})}function l(e={}){const{wrapper:s}={...(0,c.a)(),...e.components};return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(h,{...e})}):h(e)}function p(e,s){throw new Error("Expected "+(s?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}},1151:(e,s,n)=>{n.d(s,{Z:()=>d,a:()=>i});var t=n(7294);const c={},o=t.createContext(c);function i(e){const s=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function d(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(c):e.components||c:i(e.components),t.createElement(o.Provider,{value:s},e.children)}}}]);